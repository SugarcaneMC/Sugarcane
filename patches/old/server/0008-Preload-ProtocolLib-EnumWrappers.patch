From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: ishland <ishlandMC@yeah.net>
Date: Tue, 7 Dec 2021 20:05:18 -0500
Subject: [PATCH] Preload ProtocolLib EnumWrappers

Original code by Yatopia, licensed under MIT License

diff --git a/src/main/java/net/minecraft/server/MinecraftServer.java b/src/main/java/net/minecraft/server/MinecraftServer.java
index 47a73b77b73499ed696064ea85104c0a3b5d9902..da6a62a100ad7d8271b28f57d06e8569bdee2ed0 100644
--- a/src/main/java/net/minecraft/server/MinecraftServer.java
+++ b/src/main/java/net/minecraft/server/MinecraftServer.java
@@ -1235,6 +1235,8 @@ public abstract class MinecraftServer extends ReentrantBlockableEventLoop<TickTa
                 LOGGER.info("Done ({})! For help, type \"help\"", doneTime);
                 // Paper end
 
+                if (org.sugarcanemc.sugarcane.config.SugarcaneConfig.fixProtocolLib) org.sugarcanemc.sugarcane.util.SugarcanePreloadProtocolLib.run(); // Sugarcane - Preload ProtocolLib's Enum Wrappers
+
                 org.spigotmc.WatchdogThread.tick(); // Paper
                 org.spigotmc.WatchdogThread.hasStarted = true; // Paper
                 Arrays.fill( recentTps, 20 );
diff --git a/src/main/java/org/sugarcanemc/sugarcane/config/SugarcaneConfig.java b/src/main/java/org/sugarcanemc/sugarcane/config/SugarcaneConfig.java
index cce5ba02ac86bc23557d04d2d9b4a4a52e96bd02..3be8d0697fcbda15fc49945eb9bdac2d82dbac13 100644
--- a/src/main/java/org/sugarcanemc/sugarcane/config/SugarcaneConfig.java
+++ b/src/main/java/org/sugarcanemc/sugarcane/config/SugarcaneConfig.java
@@ -109,18 +109,11 @@ public class SugarcaneConfig {
 			num = 0D;
 		}
 		switch (unit) {
-			case 'd':
-				num *= (double) 60 * 60 * 24;
-			    break;
-			    case 'h':
-				num *= (double) 60 * 60;
-			    break;
-			    case 'm':
-				num *= 60;
-                break;
-				default:
-			    case 's':
-				    break;
+			case 'd':  num *= (double) 60 * 60 * 24;
+			case 'h':  num *= (double) 60 * 60;
+			case 'm':  num *= 60;
+			case 's':  break;
+			default: break;
 		}
 		return (int) num;
 }
@@ -178,6 +171,11 @@ public class SugarcaneConfig {
 		return config.getString(path, config.getString(path));
 }
 
+	public static boolean fixProtocolLib = true;
+	private static void protocolLib() {
+		fixProtocolLib = getBoolean("settings.fix-protocollib", fixProtocolLib);
+	}
+
 	public static boolean disableEntityStuckChecks = false;
 private static void disableEntityStuckChecks() {
 	disableEntityStuckChecks = getBoolean("settings.disableEntityStuckChecks", false);
diff --git a/src/main/java/org/sugarcanemc/sugarcane/util/SugarcanePreloadProtocolLib.java b/src/main/java/org/sugarcanemc/sugarcane/util/SugarcanePreloadProtocolLib.java
new file mode 100644
index 0000000000000000000000000000000000000000..c5c4a37162c26d88a7fac5bde75def39985706dc
--- /dev/null
+++ b/src/main/java/org/sugarcanemc/sugarcane/util/SugarcanePreloadProtocolLib.java
@@ -0,0 +1,28 @@
+package org.sugarcanemc.sugarcane.util;
+
+import net.minecraft.server.MinecraftServer;
+import org.bukkit.Bukkit;
+import org.bukkit.plugin.Plugin;
+import org.bukkit.plugin.SimplePluginManager;
+
+import java.lang.reflect.Method;
+
+public class SugarcanePreloadProtocolLib {
+
+    public synchronized static void run() {
+        try {
+            final SimplePluginManager pluginManager = (SimplePluginManager) Bukkit.getPluginManager();
+            final Plugin protocolLib = pluginManager.getPlugin("ProtocolLib");
+            if(protocolLib != null && protocolLib.isEnabled()) {
+                MinecraftServer.LOGGER.info("Sugarcane: Attempting to preload ProtocolLib's EnumWrappers");
+                final Method initialize = Class.forName("com.comphenix.protocol.wrappers.EnumWrappers", true, protocolLib.getClass().getClassLoader()).getDeclaredMethod("initialize");
+                initialize.setAccessible(true);
+                initialize.invoke(null);
+                synchronized (SugarcanePreloadProtocolLib.class) {
+                }
+            }
+        } catch (Throwable t) {
+            MinecraftServer.LOGGER.warn("Sugarcane: Failed to preload ProtocolLib's EnumWrappers", t);
+        }
+    }
+}
\ No newline at end of file
